direction: down

# Start node
Start: {
  label: "Start:\nCurrent Working Directory"
  shape: oval
  style: {
    fill: "#e1f5fe"
    stroke: "#01579b"
    stroke-width: 2
  }
}

# Tier 1: Declared Path
CheckDeclared: {
  label: "Check Declared\nNotebook Path\n--notebook flag or\nOPENNOTES_NOTEBOOK env"
  shape: diamond
  style: {
    fill: "#fff3e0"
    stroke: "#ef6c00"
    stroke-width: 2
  }
}

HasDeclaredConfig: {
  label: "Has .opennotes.json\nin declared path?"
  shape: diamond
  style: {
    fill: "#fff3e0"
    stroke: "#ef6c00"
    stroke-width: 2
  }
}

LoadDeclared: {
  label: "Load & Open\nDeclared Notebook"
  shape: rectangle
  style: {
    fill: "#f3e5f5"
    stroke: "#4a148c"
    stroke-width: 2
  }
}

# Tier 2: Registered Notebooks
CheckRegistered: {
  label: "Check Registered\nNotebooks from\nglobal config"
  shape: diamond
  style: {
    fill: "#fff3e0"
    stroke: "#ef6c00"
    stroke-width: 2
  }
}

ForEachRegistered: {
  label: "For each registered\nnotebook path"
  shape: rectangle
  style: {
    fill: "#f3e5f5"
    stroke: "#4a148c"
    stroke-width: 2
  }
}

HasRegisteredConfig: {
  label: "Has .opennotes.json\nin registered path?"
  shape: diamond
  style: {
    fill: "#fff3e0"
    stroke: "#ef6c00"
    stroke-width: 2
  }
}

LoadRegisteredConfig: {
  label: "Load notebook config"
  shape: rectangle
  style: {
    fill: "#f3e5f5"
    stroke: "#4a148c"
    stroke-width: 2
  }
}

CheckContext: {
  label: "Current directory\nmatches any context\nin notebook?"
  shape: diamond
  style: {
    fill: "#fff3e0"
    stroke: "#ef6c00"
    stroke-width: 2
  }
}

LoadRegistered: {
  label: "Load & Open\nMatched Notebook"
  shape: rectangle
  style: {
    fill: "#f3e5f5"
    stroke: "#4a148c"
    stroke-width: 2
  }
}

NextRegistered: {
  label: "Try next\nregistered notebook"
  shape: rectangle
  style: {
    fill: "#f3e5f5"
    stroke: "#4a148c"
    stroke-width: 2
  }
}

# Tier 3: Ancestor Search
StartAncestorSearch: {
  label: "Start Ancestor Search\ncurrent = cwd"
  shape: rectangle
  style: {
    fill: "#f3e5f5"
    stroke: "#4a148c"
    stroke-width: 2
  }
}

IsRoot: {
  label: "current == '/' or\nempty string?"
  shape: diamond
  style: {
    fill: "#fff3e0"
    stroke: "#ef6c00"
    stroke-width: 2
  }
}

HasAncestorConfig: {
  label: "Has .opennotes.json\nin current directory?"
  shape: diamond
  style: {
    fill: "#fff3e0"
    stroke: "#ef6c00"
    stroke-width: 2
  }
}

LoadAncestor: {
  label: "Load & Open\nAncestor Notebook"
  shape: rectangle
  style: {
    fill: "#f3e5f5"
    stroke: "#4a148c"
    stroke-width: 2
  }
}

GoToParent: {
  label: "current = parent\ndirectory"
  shape: rectangle
  style: {
    fill: "#f3e5f5"
    stroke: "#4a148c"
    stroke-width: 2
  }
}

# End nodes
Success: {
  label: "Success\nReturn Notebook Instance"
  shape: oval
  style: {
    fill: "#e8f5e8"
    stroke: "#1b5e20"
    stroke-width: 2
  }
}

NotFound: {
  label: "Not Found\nReturn nil"
  shape: oval
  style: {
    fill: "#ffebee"
    stroke: "#c62828"
    stroke-width: 2
  }
}

# Connections
Start -> CheckDeclared

CheckDeclared -> HasDeclaredConfig: "Path provided"
CheckDeclared -> CheckRegistered: "No path"

HasDeclaredConfig -> LoadDeclared: "Yes"
HasDeclaredConfig -> CheckRegistered: "No"

CheckRegistered -> ForEachRegistered
ForEachRegistered -> HasRegisteredConfig

HasRegisteredConfig -> NextRegistered: "No"
HasRegisteredConfig -> LoadRegisteredConfig: "Yes"

LoadRegisteredConfig -> CheckContext

CheckContext -> LoadRegistered: "Yes"
CheckContext -> NextRegistered: "No"

NextRegistered -> HasRegisteredConfig: "More notebooks"
NextRegistered -> StartAncestorSearch: "No more notebooks"

StartAncestorSearch -> IsRoot

IsRoot -> NotFound: "Yes"
IsRoot -> HasAncestorConfig: "No"

HasAncestorConfig -> LoadAncestor: "Yes"
HasAncestorConfig -> GoToParent: "No"

GoToParent -> IsRoot

LoadDeclared -> Success
LoadRegistered -> Success
LoadAncestor -> Success
